pipeline {
    agent any

    // This flag will track if we need to run the retry stage
    environment {
        TESTS_FAILED = 'false'
    }

    stages {
        stage('Build & Test') {
            steps {
                script {
                    try {
                        // 1. Run the build. 
                        //    'clean' is OK here because it's the FIRST run.
                        sh "mvn clean verify"

                    } catch (Exception e) {
                        
                        // 2. TESTS FAILED!
                        //    Mark the flag so the retry stage will run
                        env.TESTS_FAILED = 'true'
                        
                        echo "Tests failed. Stashing rerun files..."
                        
                        // 3. IMPORTANT: Save the rerun files
                        //    This saves the files needed by Failsafe to a safe
                        //    "stash" area named 'rerun-files'.
                        stash name: 'rerun-files', includes: 'target/failsafe-reports/*failsafe-summary.xml'
                    }
                }
            }
        }

        stage('Retry Failed Tests') {
            // 4. This stage ONLY runs if the TEST_FAILED flag was set
            when {
                expression { env.TESTS_FAILED == 'true' }
            }
            steps {
                script {
                    echo "Tests failed on the first run. Retrying..."
                    
                    // 5. Bring the saved files back into the workspace
                    unstash 'rerun-files'

                    // 6. Run the retry command.
                    //    !!! NOTICE: DO NOT use 'mvn clean' here !!!
                    //    That would delete the files you just unstashed.
                    //
                    //    Failsafe will automatically find the summary files
                    //    and rerun only the failures.
                    sh "mvn failsafe:integration-test" 
                    
                    // If this step also fails, the whole build will be 
                    // marked as FAILED (which is correct).
                }
            }
        }
    }
    
    post {
        // 7. CLEANUP
        //    This now runs at the VERY end, after the retry
        //    stage has already finished.
        always {
            echo "Build finished. Cleaning workspace."
            cleanWs()
        }
    }
}
